/*! autoCompleter - v0.0.0 - 2014-05-16 
Author: Miranda li
Email: mli@hugeinc.com
*/"use strict";var AutoCompleter=function(a,b){var c={filter:a.querySelector("input.filter"),filterTarget:a.querySelector(".result"),elementSelector:"li",typingConfig:{minimal:3,typePause:300},filterOnly:!1};this.options=this._extend(c,b),this.handle=a,this.filterElement=this.options.filterTarget.querySelectorAll(this.options.elementSelector),this.dataCache=[],this.timer=null,this.regex=null,this.allowAjax=!0,this.noResult=null,this.options.filterOnly||this._init()};AutoCompleter.prototype._init=function(){return this.noResult=this.addNoResult("No result"),this.options.ajax?void this.options.filter.addEventListener("keyup",this._filterData.bind(this)):"function"==typeof this.options.customFilter?void this.options.filter.addEventListener("keyup",this.options.customFilter.bind(this)):(this.dataCache=this.options.markup?this.cacheCustomData():this.cacheMarkupData(),void this.options.filter.addEventListener("keyup",this.filterMarkup.bind(this)))},AutoCompleter.prototype.addNoResult=function(a){var b=document.createElement("span");return b.classList.add("hide","no-result"),b.innerHTML=a,this.handle.appendChild(b)},AutoCompleter.prototype.filterMarkup=function(a,b){b=b||a.target.value,this.regex=new RegExp(this._replaceStr(b),"i"),0===b.length||this.options.filterOnly?this._hideAndShowMarkup():this._checkTyping(a,this._hideAndShowMarkup)},AutoCompleter.prototype._filterData=function(a){this.regex=new RegExp(this._replaceStr(a.target.value),"i"),0!==a.target.value.length?this._checkTyping(a,this._callAjax):(this.options.filterTarget.classList.remove("loading"),this.options.filterTarget.innerHTML="",this.noResult.classList.add("hide"),this.allowAjax=!0)},AutoCompleter.prototype.cacheMarkupData=function(){if(this.filterElement){for(var a=[],b=0;b<this.filterElement.length;b++)a.push(this.filterElement[b].innerHTML);return a}},AutoCompleter.prototype.cacheCustomData=function(){if(this.filterElement||"function"==typeof this.options.markup.cacheData){for(var a=[],b=0;b<this.filterElement.length;b++)a.push(this.options.markup.cacheData(this.filterElement[b]));return a}},AutoCompleter.prototype._checkTyping=function(a,b){return clearTimeout(this.timer),a.target.value.length<this.options.typingConfig.minimal?void(this.options.ajax&&(this.allowAjax=!0)):void(this.timer=window.setTimeout(b.bind(this,a),this.options.typingConfig.typePause))},AutoCompleter.prototype._hideAndShowMarkup=function(){if(this.options.typingConfig.customHideAndShow)return void this.options.typingConfig.customHideAndShow(this);for(var a=0,b=0;b<this.dataCache.length;b++)this.dataCache[b].match(this.regex)?(this.filterElement[b].className="show",a++):this.filterElement[b].className="hide";this.onResult&&this.checkNoResult(a)},AutoCompleter.prototype.checkNoResult=function(a){0===a?this.noResult.classList.contains("hide")&&this.noResult.classList.remove("hide"):this.noResult.classList.contains("hide")||this.noResult.classList.add("hide")},AutoCompleter.prototype._callAjax=function(a){this.allowAjax&&""!==a.target.value?(this.dataCache=[],this.options.ajax.action=this.options.ajax.action||"GET",this._ajax({url:this.options.ajax.url,value:a.target.getAttribute("name")+"="+a.target.value,action:this.options.ajax.action}),this.allowAjax=!1):this._hideAndShowMarkup()},AutoCompleter.prototype._ajax=function(a){var b,c=this;c.options.filterTarget.classList.add("loading"),window.XMLHttpRequest&&(b=new XMLHttpRequest),b.onreadystatechange=function(){if(4===this.readyState)if(this.status>=200&&this.status<400){var a=this.responseText;if(this.getResponseHeader("content-type").match("json"))if(a=JSON.parse(a),c.options.ajax.renderJSON)c.dataCache=c.options.ajax.renderJSON(a,c.options.filterTarget);else{for(var b=c.options.filterTarget,d=document.createDocumentFragment(),e=0;e<a.length;e++){var f=document.createElement("li");f.innerHTML=a[e],d.appendChild(f)}b.innerHTML="",b.appendChild(d),c.dataCache=a}c.filterElement=c.options.filterTarget.querySelectorAll(c.options.elementSelector),c._hideAndShowMarkup(),c.options.filterTarget.classList.remove("loading")}else c.options.ajax.error&&c.options.ajax.error(this.responseText)},b.open(a.action,a.url),b.setRequestHeader("Content-type","application/json; charset=utf-8"),b.onerror=function(){},b.timeout=c.options.ajax.timeout||3e4,b.ontimeout=function(){c.options.ajax.timeoutCallback(this.responseText)},b.send(a.value)},AutoCompleter.prototype._replaceStr=function(a){return a.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")},AutoCompleter.prototype._extend=function(a){for(var b=Array.prototype.slice.call(arguments,1),c=0;c<b.length;c++){var d=b[c];for(var e in d)if("object"==typeof a[e])for(var f in d[e])a[e][f]=d[e][f];else a[e]=d[e]}return a};